{% extends "base.html" %}

{% block title %}Reconocimiento de Señas{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Reconocimiento de Lenguaje de Señas</h4>
                </div>
                <div class="card-body">
                    <!-- Contenedor de la cámara -->
                    <div class="camera-container mb-3" style="position: relative; width: 100%; padding-top: 75%; background-color: #f8f9fa; border-radius: 4px; overflow: hidden;">
                        <video id="video" autoplay playsinline style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;"></video>
                        <div id="startButton" class="text-center" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                            <button class="btn btn-primary btn-lg">
                                <i class="fas fa-camera"></i> Activar Cámara
                            </button>
                        </div>
                        <canvas id="canvas" style="display: none;"></canvas>
                        <div id="result" class="text-center mt-2"></div>
                    </div>
                    
                    <!-- Controles -->
                    <div class="controls text-center mt-3">
                        <button id="captureButton" class="btn btn-success" disabled>
                            <i class="fas fa-camera"></i> Capturar Foto
                        </button>
                        <button id="changeCamera" class="btn btn-secondary ml-2" style="display: none;">
                            <i class="fas fa-sync-alt"></i> Cambiar Cámara
                        </button>
                        <div class="form-check form-switch d-inline-block ml-3">
                            <input class="form-check-input" type="checkbox" id="autoCaptureSwitch">
                            <label class="form-check-label" for="autoCaptureSwitch">Captura automática</label>
                        </div>
                    </div>
                    
                    <!-- Resultados -->
                    <div id="results" class="mt-4">
                        <h5>Resultados:</h5>
                        <div id="predictions" class="list-group">
                            <!-- Aquí se mostrarán los resultados -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elementos del DOM
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureButton = document.getElementById('captureButton');
    const startButton = document.getElementById('startButton');
    const changeCameraButton = document.getElementById('changeCamera');
    const autoCaptureSwitch = document.getElementById('autoCaptureSwitch');
    const predictionsContainer = document.getElementById('predictions');
    
    let stream = null;
    let currentFacingMode = 'user'; // Por defecto cámara frontal
    let autoCaptureInterval = null;
    
    // Iniciar cámara
    async function startCamera(facingMode = 'user') {
        try {
            // Detener el stream actual si existe
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            // Obtener acceso a la cámara
            stream = await navigator.mediaDevices.getUserMedia({
                video: { 
                    facingMode: { exact: facingMode },
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            });
            
            video.srcObject = stream;
            video.play();
            
            // Configurar canvas con las dimensiones del video
            video.addEventListener('loadedmetadata', () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
            });
            
            // Mostrar controles
            startButton.style.display = 'none';
            captureButton.disabled = false;
            changeCameraButton.style.display = 'inline-block';
            
            // Iniciar captura automática si está activada
            if (autoCaptureSwitch.checked) {
                startAutoCapture();
            }
            
        } catch (err) {
            console.error('Error al acceder a la cámara:', err);
            alert('No se pudo acceder a la cámara. Asegúrate de haber otorgado los permisos necesarios.');
        }
    }
    
    // Detener cámara
    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
        startButton.style.display = 'block';
        captureButton.disabled = true;
        changeCameraButton.style.display = 'none';
        stopAutoCapture();
    }
    
    // Capturar imagen
    async function captureImage() {
        if (!stream) return;
        
        // Dibujar el frame actual en el canvas
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Obtener la imagen como blob
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9));
        
        // Crear formulario para enviar la imagen
        const formData = new FormData();
        formData.append('image', blob, 'capture.jpg');
        
        try {
            // Enviar imagen al servidor
            const response = await fetch('/api/process-image', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error('Error al procesar la imagen');
            }
            
            const result = await response.json();
            
            // Mostrar resultados
            displayResults(result);
            
        } catch (error) {
            console.error('Error:', error);
            alert('Error al procesar la imagen. Por favor, inténtalo de nuevo.');
        }
    }
    
    // Mostrar resultados
    function displayResults(data) {
        if (!data || !data.result) {
            predictionsContainer.innerHTML = '<div class="alert alert-warning">No se pudo procesar la imagen</div>';
            return;
        }
        
        // Ordenar resultados por confianza (de mayor a menor)
        const sortedResults = Object.entries(data.result)
            .sort(([, a], [, b]) => b - a)
            .slice(0, 5); // Mostrar solo las 5 mejores predicciones
        
        let html = '<div class="list-group">';
        
        sortedResults.forEach(([letter, confidence]) => {
            const percentage = (confidence * 100).toFixed(2);
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <span class="h4 mb-0">${letter}</span>
                    <div class="progress flex-grow-1 mx-3" style="height: 30px;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: ${percentage}%" 
                             aria-valuenow="${percentage}" 
                             aria-valuemin="0" 
                             aria-valuemax="100">
                            ${percentage}%
                        </div>
                    </div>
                </div>`;
        });
        
        html += '</div>';
        predictionsContainer.innerHTML = html;
    }
    
    // Captura automática
    function startAutoCapture() {
        stopAutoCapture(); // Detener cualquier intervalo existente
        autoCaptureInterval = setInterval(captureImage, 2000); // Capturar cada 2 segundos
    }
    
    function stopAutoCapture() {
        if (autoCaptureInterval) {
            clearInterval(autoCaptureInterval);
            autoCaptureInterval = null;
        }
    }
    
    // Event Listeners
    startButton.addEventListener('click', () => startCamera(currentFacingMode));
    captureButton.addEventListener('click', captureImage);
    
    changeCameraButton.addEventListener('click', () => {
        currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
        startCamera(currentFacingMode);
    });
    
    autoCaptureSwitch.addEventListener('change', (e) => {
        if (e.target.checked) {
            startAutoCapture();
        } else {
            stopAutoCapture();
        }
    });
    
    // Limpiar al cerrar la página
    window.addEventListener('beforeunload', () => {
        stopCamera();
        stopAutoCapture();
    });
});
</script>
{% endblock %}
